module quads
  use data_types
  use tblinf
  implicit none
  real(kind=8),private :: pc_pi, trd,frd,erd,it1,it2
  !real(kind=8), allocatable, dimension(:,:),private :: vr,vph,vth,rho
  !real(kind=8),private :: r,pot
  parameter(pc_pi = acos(-1.d0))
  parameter(trd = 2.d0/3.d0)
  parameter(frd = 4.d0/3.d0)
  parameter(erd = 8.d0/3.d0)
  parameter(it1 = sqrt(4.0d0*pc_pi))
  parameter(it2 = (4.0d0*pc_pi))
  

contains

  ! subroutine set_vars(vel1,vel2,vel3,den,radi,gpo)
  !   real(kind=8),dimension(:,:), intent(in) :: vel1,vel2,vel3,den
  !   real(kind=8), intent(in) :: radi,gpo
  !   integer :: i,ast
  !   ALLOCATE (vr(0:lmax,-lmax:lmax), STAT = ast)
  !   ALLOCATE (vph(0:lmax,-lmax:lmax), STAT = ast)
  !   ALLOCATE (vth(0:lmax,-lmax:lmax), STAT = ast)
  !   ALLOCATE (rho(0:lmax,-lmax:lmax), STAT = ast)

  !   vr = vel1 ; vph = vel3; vth = vel2; rho = den;
  !   r = radi; pot = gpo;
  ! end subroutine set_vars

    
  subroutine calc_quads(Q11,Q22,Q33,Q12,Q13,Q23,vel1,vel2,vel3,den,radi,gpo)
    implicit none
    real(kind=8),dimension(:,:), intent(in) :: vel1,vel2,vel3,den
    real(kind=8), intent(in) :: radi,gpo
    integer :: i,ast
   
    real(kind=8), intent(out) :: Q11,Q22,Q33,Q12,Q13,Q23
    real(kind=8) :: res,tmp1,tmp2,tmp3,tmp4,tmp5,tmp6,tmp7,tmp8,tmp9
    real(kind=8) :: tmp10,tmp11,tmp12,tmp13,tmp14,tmp15,tmp16
    real(kind=8) :: qt11,qt22,qt33,qt12,qt13,qt23
    real(kind=8), allocatable, dimension(:,:) :: vr,vph,vth,rho
    real(kind=8) :: r,pot

    integer :: l1,m1,l2,m2,l3,m3
    integer :: i1,i2,i3,i4,i5,i6,i7,i8,i9,i10,i11,i12,i13,i14,i15,i16
    integer :: j1,j2,j3,j4,j5,j6,j7,j8,j9,j10,j11,j12,j13,j14,j15,j16
   
    ALLOCATE (vr(0:lmax,-lmax:lmax), STAT = ast)
    ALLOCATE (vph(0:lmax,-lmax:lmax), STAT = ast)
    ALLOCATE (vth(0:lmax,-lmax:lmax), STAT = ast)
    ALLOCATE (rho(0:lmax,-lmax:lmax), STAT = ast)

    vr = vel1 ; vph = vel3; vth = vel2; rho = den;
    r = radi; pot = gpo;



    i1 = 0; i2 = 0; i3 = 0; i4 = 0; i5 = 0; i6 = 0; i7 = 0; i8 = 0; i9 = 0;
    i10 = 0; i11 = 0; i12 = 0; i13 = 0; i14 = 0; i15 = 0; i16 = 0;
    j1 = 0; j2 = 0; j3 = 0; j4 = 0; j5 = 0; j6 = 0; j7 = 0; j8 = 0; j9 = 0;
    j10 = 0; j11 = 0; j12 = 0; j13 = 0; j14 = 0; j15 = 0; j16 = 0;
    Q11 = 0.0d0; Q22 = 0.0d0; Q33 = 0.0d0; Q12 = 0.0d0; Q13 = 0.0d0; Q23 = 0.0d0;
    do l1 = 0,lmax       
       do m1 = -l1,l1
          qt11 = 0.0d0; qt22 = 0.0d0; qt33 = 0.0d0; qt12 = 0.0d0; qt13 = 0.0d0; qt23 = 0.0d0;
          do l2 = 0,lmax
             do m2 = -l2,l2
                do l3 = 0,lmax
                   do m3 = -l3,l3
                      tmp1 = 0.0d0; tmp2 = 0.0d0; tmp3 = 0.0d0;
                      tmp4 = 0.0d0; tmp5 = 0.0d0; tmp6 = 0.0d0;
                      tmp7 = 0.0d0; tmp8 = 0.0d0; tmp9 = 0.0d0;
                      tmp10 = 0.0d0; tmp11 = 0.0d0; tmp12 = 0.0d0;
                
                      j1 = incr(l1, m1, l2, m2, l3, m3, 0, 2, 0, 0,i1)
                      if(j1 .gt.i1) then 
                         i1=j1
                         tmp1 = ts1(i1)!tmp1 = ILU(l1, m1, l2, m2, l3, m3, 0, 2, 0, 0)
                      endif
                      j2 = incr(l1, m1, l2, m2, l3, m3, 0, 2, 0, 2,i2)
                      if(j2 .gt.i2) then 
                         i2=j2
                         tmp2 = ts2(i2)!tmp2 = ILU(l1, m1, l2, m2, l3, m3, 0, 2, 0, 2)
                      endif
                      j3 = incr(l1, m1, l2, m2, l3, m3, 0, 2, 2, 0,i3)
                      if(j3 .gt.i3) then 
                         i3=j3
                         tmp3 = ts3(i3)!tmp3 = ILU(l1, m1, l2, m2, l3, m3, 0, 2, 2, 0)
                      endif
                      j4 = incr(l1, m1, l2, m2, l3, m3, 1, 1, 0, 0,i4)
                      if(j4 .gt.i4) then 
                         i4=j4
                         tmp4 = ts4(i4)!tmp4 = ILU(l1, m1, l2, m2, l3, m3, 1, 1, 0, 0)
                      endif
                      j5 = incr(l1, m1, l2, m2, l3, m3, 1, 1, 0, 2,i5)
                      if(j5 .gt.i5) then 
                         i5=j5
                         tmp5 = ts5(i5)!tmp5 = ILU(l1, m1, l2, m2, l3, m3, 1, 1, 0, 2)
                      endif
                      j6 = incr(l1, m1, l2, m2, l3, m3, 1, 1, 2, 0,i6)
                      if(j6 .gt.i6) then 
                         i6=j6
                         tmp6 = ts6(i6)!tmp6 = ILU(l1, m1, l2, m2, l3, m3, 1, 1, 2, 0)
                      endif
                      j7 = incr(l1, m1, l2, m2, l3, m3, 2, 0, 0, 0,i7)
                      if(j7 .gt.i7) then 
                         i7=j7
                         tmp7 = ts7(i7)!tmp7 = ILU(l1, m1, l2, m2, l3, m3, 2, 0, 0, 0)
                      endif
                      j8 = incr(l1, m1, l2, m2, l3, m3, 2, 0, 0, 2,i8)
                      if(j8 .gt.i8) then 
                         i8=j8
                         tmp8 = ts8(i8)!tmp8 = ILU(l1, m1, l2, m2, l3, m3, 2, 0, 0, 2)
                      endif
                      j9 = incr(l1, m1, l2, m2, l3, m3, 2, 0, 2, 0,i9)
                      if(j9 .gt.i9) then 
                         i9=j9
                         tmp9 = ts9(i9)!tmp9 = ILU(l1, m1, l2, m2, l3, m3, 2, 0, 2, 0)
                      endif
                      j10 = incr(l1, m1, l2, m2, l3, m3, 0, 2, 0, 1,i10)
                      if(j10 .gt.i10) then 
                         i10=j10
                         tmp10 = ts10(i10)!tmp10 = ILU(l1, m1, l2, m2, l3, m3, 0, 2, 0, 1)
                      endif
                      j11 = incr(l1, m1, l2, m2, l3, m3, 1, 1, 0, 1,i11)
                      if(j11 .gt.i11) then 
                         i11=j11
                         tmp11 = ts11(i11)!tmp11 = ILU(l1, m1, l2, m2, l3, m3, 1, 1, 0, 1)
                      endif
                      j12 = incr(l1, m1, l2, m2, l3, m3, 2, 0, 0, 1,i12)
                      if(j12 .gt.i12) then 
                         i12=j12
                         tmp12 = ts12(i12)!tmp12 = ILU(l1, m1, l2, m2, l3, m3, 2, 0, 0, 1)
                      endif
                      qt11 = qt11 + &
                           trd*tmp1*vr(l2,m2)*vr(l3,m3) +&
                           frd*tmp2*r**2*vth(l2,m2)*vth(l3,m3) -&
                           trd*tmp3*r**2*vth(l2,m2)*vth(l3,m3) +&
                           frd*tmp4*r*vr(l2,m2)*vth(l3,m3) +&
                           erd*tmp5*r*vr(l2,m2)*vth(l3,m3) -&
                           frd*tmp6*r*vr(l2,m2)*vth(l3,m3) -&
                           trd*tmp7*r**2*vth(l2,m2)*vth(l3,m3) -&
                           trd*tmp8*r**2*vph(l2,m2)*vph(l3,m3) +&
                           frd*tmp8*vr(l2,m2)*vr(l3,m3) +&
                           frd*tmp9*r**2*vph(l2,m2)*vph(l3,m3) -&
                           trd*tmp9*vr(l2,m2)*vr(l3,m3)


                      qt22 = qt22 + &
                           trd*tmp1*vr(l2,m2)*vr(l3,m3) -&
                           trd*tmp2*r**2*vth(l2,m2)*vth(l3,m3) +&
                           frd*tmp3*r**2*vth(l2,m2)*vth(l3,m3) +&
                           frd*tmp4*r*vr(l2,m2)*vth(l3,m3) -&
                           frd*tmp5*r*vr(l2,m2)*vth(l3,m3) +&
                           erd*tmp6*r*vr(l2,m2)*vth(l3,m3) -&
                           trd*tmp7*r**2*vth(l2,m2)*vth(l3,m3) +&
                           frd*tmp8*r**2*vph(l2,m2)*vph(l3,m3) -&
                           trd*tmp8*vr(l2,m2)*vr(l3,m3) -&
                           trd*tmp9*r**2*vph(l2,m2)*vph(l3,m3) +&
                           frd*tmp9*vr(l2,m2)*vr(l3,m3)
                           
                      qt33 = qt33 + &
                           frd*tmp1*vr(l2,m2)*vr(l3,m3) -&
                           trd*tmp2*r**2*vth(l2,m2)*vth(l3,m3) -&
                           trd*tmp3*r**2*vth(l2,m2)*vth(l3,m3) -&
                           erd*tmp4*r*vr(l2,m2)*vth(l3,m3) -&
                           frd*tmp5*r*vr(l2,m2)*vth(l3,m3) -&
                           frd*tmp6*r*vr(l2,m2)*vth(l3,m3) +&
                           frd*tmp7*r**2*vth(l2,m2)*vth(l3,m3) -&
                           trd*tmp8*r**2*vph(l2,m2)*vph(l3,m3) -&
                           trd*tmp8*vr(l2,m2)*vr(l3,m3) -&
                           trd*tmp9*r**2*vph(l2,m2)*vph(l3,m3) -&
                           trd*tmp9*vr(l2,m2)*vr(l3,m3)

                      qt12 = qt12 + 2.0*tmp5*r**2*vph(l2,m2)*vth(l3,m3) -&
                           2.0*tmp6*r**2*vph(l2,m2)*vth(l3,m3) +&
                           2.0*tmp8*r*vph(l3,m3)*vr(l2,m2) -&
                           2.0*tmp9*r*vph(l3,m3)*vr(l2,m2)

                      qt13 = qt13 + &
                           2.0*tmp10*r*vr(l2,m2)*vth(l3,m3) -&
                           2.0*tmp11*r**2*vth(l2,m2)*vth(l3,m3) +&
                           2.0*tmp11*vr(l2,m2)*vr(l3,m3) -&
                           2.0*tmp12*r*vr(l2,m2)*vth(l3,m3)


                      qt23 = 2.0*tmp11*r*vph(l3,m3)*vr(l2,m2) -&
                           2.0*tmp12*r**2*vph(l2,m2)*vth(l3,m3)
                      
                   end do
                end do
             end do
          end do
          tmp13 = 0.0d0; tmp14 = 0.0d0; tmp15 = 0.0d0;
          tmp16 = 0.0d0;
                     
          j13 = incr(l1, m1, 0, 0, 0, 0, 1, 1, 2, 0,i13)
          if(j13 .gt. i13) then
             i13=j13
             tmp13=ts13(i13)!tmp13=(l1, m1, 0, 0, 0, 0, 1, 1, 2, 0)             
          end if

          j14 = incr(l1, m1, 0, 0, 0, 0, 2, 0, 0, 2,i14)
          if(j14 .gt. i14) then
             i14=j14
             tmp14=ts14(i14)!tmp14=(l1, m1, 0, 0, 0, 0, 2, 0, 0, 2)                                                                    
          end if
          
          j15 = incr(l1, m1, 0, 0, 0, 0, 0, 2, 0, 0,i15)
          if(j15 .gt. i15) then
             i15=j15
             tmp15=ts15(i15)!tmp15=(l1, m1, 0, 0, 0, 0, 0, 2, 0, 0)   
          end if

          j16 = incr(l1, m1, 0, 0, 0, 0, 1, 1, 0, 1,i16)
          if(j16 .gt. i16) then
             i16=j16
             tmp16=ts16(i16)!tmp16=(l1, m1, 0, 0, 0, 0, 1, 1, 0, 1) 
          end if

          qt11 = qt11 + trd*pot*it2*tmp13*r - frd*pot*it2*tmp14*r
          qt22 = qt22 - frd*pot*it2*tmp13*r + trd*pot*it2*tmp14*r
          qt33 = qt33 -2.0*pot*it2*tmp15*r + trd*pot*it2*tmp13*r + trd*pot*it2*tmp14*r
          qt13 = qt13 - 2.0*pot*it2*tmp16*r
          
          Q11 = Q11+ qt11*rho(l1,m1) ; Q22 = Q22+ qt22*rho(l1,m1) ; Q33 = Q33+ qt33*rho(l1,m1)
          Q12 = Q12+ qt12*rho(l1,m1) ; Q13 = Q13+ qt13*rho(l1,m1) ; Q23 = Q23+ qt23*rho(l1,m1)
       end do
    end do
  end subroutine calc_quads
end module quads


! tmp13 = ILU(l1, m1, 0, 0, 0, 0, 1, 1, 2, 0)
! tmp14 = ILU(l1, m1, 0, 0, 0, 0, 2, 0, 0, 2)
! tmp15 = ILU(l1, m1, 0, 0, 0, 0, 0, 2, 0, 0)
! tmp16 = ILU(l1, m1, 0, 0, 0, 0, 1, 1, 0, 1)
! tmp1 = ILU(l1, m1, l2, m2, l3, m3, 0, 2, 0, 0)
! tmp2 = ILU(l1, m1, l2, m2, l3, m3, 0, 2, 0, 2)
! tmp3 = ILU(l1, m1, l2, m2, l3, m3, 0, 2, 2, 0)
! tmp4 = ILU(l1, m1, l2, m2, l3, m3, 1, 1, 0, 0)
! tmp5 = ILU(l1, m1, l2, m2, l3, m3, 1, 1, 0, 2)
! tmp6 = ILU(l1, m1, l2, m2, l3, m3, 1, 1, 2, 0)
! tmp7 = ILU(l1, m1, l2, m2, l3, m3, 2, 0, 0, 0)
! tmp8 = ILU(l1, m1, l2, m2, l3, m3, 2, 0, 0, 2)
! tmp9 = ILU(l1, m1, l2, m2, l3, m3, 2, 0, 2, 0)
! tmp10 = ILU(l1, m1, l2, m2, l3, m3, 0, 2, 0, 1)
! tmp11 = ILU(l1, m1, l2, m2, l3, m3, 1, 1, 0, 1)
! tmp12 = ILU(l1, m1, l2, m2, l3, m3, 2, 0, 0, 1)
